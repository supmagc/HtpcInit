#!/bin/bash

PATH_BASE="$(dirname $0)/../"
source $PATH_BASE/common/paths
source $PATH_BASE/common/functions

PID=$(get_pid_from_file "$PATH_STEAM_PID")

function no_active_window {
  xdotool getactivewindow
  EC=$?
  if [ $EC -ne 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function steam_start {
  validate_pid_for_name "$PID" "steam"
  if [ ! $(validate_pid_for_name "$PID" "steam") ]; then
	echo "No current steam process found, starting anew"
	steam -bigpicture &
    PID=$!
    echo "$PID">"$PATH_STEAM_PID"
  else
    echo "Existing steam process found, resuming"
    steam steam://open/bigpicture
  fi
}

function steam_activate {
  echo "(Re)Activating steam"
  steam steam://open/bigpicture
}

function steam_has_open_window {
  if [ "$(no_active_window)" = "true" ]; then
    echo "false"
  else 
    local WINDOW_NAME=$(xdotool getactivewindow getwindowname)
	if [ "$WINDOW_NAME" = "Steam" ] || [ "$WINDOW_NAME" = "[Streaming]" ]; then
      echo "true"
    else
      echo "false"
	fi
  fi
}

function steam_is_active_fullscreen {
  WINDOW=$(echo $(xwininfo -id $(xdotool getactivewindow) -stats | \
                  egrep '(Width|Height):' | \
                  awk '{print $NF}') | \
           sed -e 's/ /x/')
  SCREEN=$(xdpyinfo | grep -m1 dimensions | awk '{print $2}')
  if [ "$WINDOW" = "$SCREEN" ]; then
    echo "true"
  else
    echo "false"
  fi
}

# Detect when steam closed
function steam_is_closed {
  validate_pid_for_name "$PID" "steam"
  if [ $(validate_pid_for_name "$PID" "steam") ]; then
    echo "true"
  else
    echo "false"
  fi
}

# Detect when steam minimized
function steam_is_minimized {
  echo "false"
}

# Force close steam and all subprocesses
function steam_close {
  killall -q steam.sh
  killall -q steam
  killall -q steamwebhelper
}

case "$1" in

  open_and_wait) 
	$PATH_KODI_CONTROL close
    echo "Opening Steam"
	steam_start
	
	WAIT=0
	while [ "$(steam_has_open_window)" = "false" ] && [ $WAIT -lt 60 ]; do
	  echo "Waiting for steam to open up"
	  sleep 1s
	  WAIT=$(($WAIT+1))
	done
	
	while [ "$(steam_is_closed)" = "false" ] && [ "$(steam_is_minimized)" = "false" ]; do
	  if [ "$(no_active_window)" = "true" ]; then
	    echo "No active window found"
	    sleep 10s
	    if [ "$(no_active_window)" = "true" ]; then
	    echo "Still no active window after 10sec: (re)activating steam"
		  steam_activate
  	    fi
	  fi
	  
	  if [ "$(steam_has_open_window)" = "true" ] && [ "$(steam_is_active_fullscreen)" = "false" ]; then
	    echo "Steam is open and active, but not fullscreen: maximizing screen"
	    steam_maximize
	  fi
	  sleep 1s
	done
	
	echo "Steam closed or minimized"
	$PATH_KODI_CONTROL open
    ;;

  close)
    echo "Closing Steam"
	steam_close
    ;;

esac